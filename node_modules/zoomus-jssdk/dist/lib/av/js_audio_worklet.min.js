function Queue(){this.a=[];this.b=0;this.residue=null}Queue.prototype.getLength=function(){return this.a.length-this.b};Queue.prototype.isEmpty=function(){return 0==this.a.length};Queue.prototype.enqueue=function(e){this.a.push(e)};Queue.prototype.dequeue=function(){if(0!=this.a.length){var e=this.a[this.b];2*++this.b>=this.a.length&&(this.a=this.a.slice(this.b),this.b=0);return e}return null};Queue.prototype.peek=function(){return 0<this.a.length?this.a[this.b]:void 0};function AudioQueueMGR(){this.ssrcQueueMap=new Map;AudioQueueMGR.prototype.AddQueue=function(e){var t=new Queue;this.ssrcQueueMap.set(e,t);return t};AudioQueueMGR.prototype.DeleteQueue=function(e){this.ssrcQueueMap.delete(e)};AudioQueueMGR.prototype.GetQueue=function(e){var t=this.ssrcQueueMap.get(e);return t};AudioQueueMGR.prototype.GetQueueData=function(e){var t=this.ssrcQueueMap.get(e);return t.dequeue()};AudioQueueMGR.prototype.PutQueueData=function(e,t){var u=this.ssrcQueueMap.get(e);u.enqueue(t)};AudioQueueMGR.prototype.GetQueueLength=function(e){var t=this.ssrcQueueMap.get(e);if(t!==null){return t.getLength()}return 0}}var AudioMGR=function(){function e(){this.map=new Map;this.AudioQueueMGR=new AudioQueueMGR;this.timemap=new Map}e.prototype.Add=function(e,t){this.map.put(e,t);this.AudioQueueMGR.AddQueue(e)};e.prototype.Clear=function(){this.map.clear()};e.prototype.Keys=function(){return this.map.keys()};e.prototype.UpdateSSRCTimeMap=function(e){this.timemap=e};e.prototype.GetSSRCTimeMap=function(e){if(this.timemap){return this.timemap.get(e)}return null};return e}();function Float32Concat(e,t){var u=0;if(e!==null){u=e.length;var r=new Float32Array(u+t.length);r.set(e);r.set(t,u);return r}return t}function Int16ToFloat32(e,t,u){var r=new Float32Array(e.length-t);for(var a=t;a<u;a++){var o=e[a];var i=o/32768;if(i>1)i=1;if(i<-1)i=-1;r[a]=i}return r}function Update_Audio_SSRC_Time(e){if(localAudioDecMGR){localAudioDecMGR.UpdateSSRCTimeMap(e)}}function Uint8ToFloat32(e){var t=new Int16Array(e.length/2);for(var u=0;u<t.length;u++){t[u]=(e[u*2]&255)+((e[u*2+1]&255)<<8)}return Int16ToFloat32(t,0,t.length)}function Get_Decoded_Audio_Buffer_Length(e){e=0;if(localAudioDecMGR){return localAudioDecMGR.AudioQueueMGR.GetQueueLength(e)}return 0}var start_play=false;var localAudioDecMGR=new AudioMGR;var audioBufferSize=15;var start_capture=false;var current_ssrc=null;var audio_count=0;var AUDIO_UPDATE_SSRC_TIME_INTERVAL=23;var LOG_PRINT_INTERVAL=1e4;var log_count=0;var post_capture_audio_count=0;var AUDIO_CAPTURE_MAX_COUNT=10;var capture_audio_buffer=new Float32Array(128*AUDIO_CAPTURE_MAX_COUNT);var audioEncodePort;var audioDecodePort;function Put_Audio_Frame_Buffer(e,t,u,r){e=0;if(!start_play){return}if(localAudioDecMGR){var a=localAudioDecMGR.AudioQueueMGR.GetQueue(e);if(!a){a=localAudioDecMGR.AudioQueueMGR.AddQueue(e)}t=Uint8ToFloat32(t);if(u){var o=new Map;var i=u.length/12;var n=0;var s=0;for(n=0;n<i;n++){var e=0;for(s=n*12+0;s<n*12+4;s++){e+=u[s]*Math.pow(256,s-n*12)}e=e>>10;var d=0;for(s=n*12+4;s<n*12+12;s++){d+=u[s]*Math.pow(256,s-n*12-4)}o.set(e,d)}var c={buffer:t,ntptime:o}}else{var c={buffer:t,ntptime:null}}a.enqueue(c);var l=Get_Decoded_Audio_Buffer_Length(e);if(l>audioBufferSize+2)console.log("the length is "+l);if(l>50){var f=l-audioBufferSize;while(f>=0){Delete_Decoded_Audio_Frame(e);f--}}else if(l>15){if(audioDecodePort)audioDecodePort.postMessage({status:"delay"})}}}function Delete_Decoded_Audio_Frame(e){e=0;if(!localAudioDecMGR){return}var t=localAudioDecMGR.AudioQueueMGR.GetQueue(e);if(t){var u=t.dequeue();return u}return null}function Get_SSRC_Latest_Time(e){e=e>>10;if(localAudioDecMGR){var t=localAudioDecMGR.GetSSRCTimeMap(e);if(t===null){return 0}else{return t}}}function Get_Decoded_Audio_Frame(e,t,u){if(!localAudioDecMGR){return}e=0;var r=u;var a=localAudioDecMGR.AudioQueueMGR.GetQueue(e);var o=null;if(a){if(a.residue){if(a.residue.buffer.length>u){o=a.residue.buffer.slice(0,u);a.residue.buffer=a.residue.buffer.slice(u);Update_Audio_SSRC_Time(a.residue.ntptime);return o}else if(a.residue.buffer.length===u){o=a.residue.buffer;Update_Audio_SSRC_Time(a.residue.ntptime);a.residue=null;return o}else{o=a.residue.buffer;Update_Audio_SSRC_Time(a.residue.ntptime);a.residue=null;u=u-o.length}}var i=a.dequeue();while(i&&i.buffer.length<u){Update_Audio_SSRC_Time(i.ntptime);o=Float32Concat(o,i.buffer);u=u-i.buffer.length;i=a.dequeue()}if(i){Update_Audio_SSRC_Time(i.ntptime);if(u!==0&&i.buffer.length===u){o=Float32Concat(o,i.buffer)}else if(u!==0&&i.buffer.length>u){o=Float32Concat(o,i.buffer.slice(0,u));a.residue={buffer:i.buffer.slice(u),ntptime:i.ntptime}}}if(o){if(o.length<r){a.residue={buffer:o,ntptime:null};return null}else if(o.length==r){return o}}}return null}class ZoomAudioWorletProcessor extends AudioWorkletProcessor{static get parameterDescriptors(){return[{name:"pcm",defaultValue:1}]}constructor(){super();this.port.onmessage=this.handleMessage.bind(this)}handleMessage(e){var t=e.data;switch(t.status){case"data":{if(start_play){Put_Audio_Frame_Buffer(t.data.ssrc,t.data.data,t.data.time,this);current_ssrc=t.data.ssrc}}break;case"stopPlayAudio":{start_play=false}break;case"startPlayAudio":{start_play=true}break;case"close":{}break;case"StartCaptureAudio":{start_capture=true;post_capture_audio_count=0}break;case"CurrentSSRC":{current_ssrc=t.data}break;case"encodeAudioPort":{if(audioEncodePort){audioEncodePort.close()}audioEncodePort=e.ports[0]}break;case"decodeAudioPort":{var u=this;if(audioDecodePort){audioDecodePort.close()}audioDecodePort=e.ports[0];audioDecodePort.onmessage=function(e){if(start_play){Put_Audio_Frame_Buffer(e.data.ssrc,e.data.data,e.data.time,u);current_ssrc=e.data.ssrc}if(start_capture){var t={command:"EchoCancel",data:e.data.aec,channels:e.data.channels,sampleHz:e.data.sampleHz};audioEncodePort.postMessage(t,[t.data.buffer])}}}break}}process(e,t,u){let r=e[0];let a=t[0];var o=Get_Decoded_Audio_Frame(0,0,a[0].length);if(start_capture){var i=new Float32Array(r[0].length);capture_audio_buffer.set(r[0],post_capture_audio_count*128);post_capture_audio_count++;if(post_capture_audio_count==AUDIO_CAPTURE_MAX_COUNT){post_capture_audio_count=0;audioEncodePort.postMessage({command:"EncodeAudioFrame",data:capture_audio_buffer})}}if(current_ssrc){audio_count++;if(audio_count==AUDIO_UPDATE_SSRC_TIME_INTERVAL){audio_count=0;var n=Get_SSRC_Latest_Time(current_ssrc);if(n){this.port.postMessage({status:"InstantAudioTime",data:n})}}}for(let e=0;e<a.length;++e){let t=a[e];for(let e=0;e<t.length;++e){if(o&&e<o.length){t[e]=o[e]}else{log_count++;if(log_count==LOG_PRINT_INTERVAL){console.log("Audio Buffer is Empty");log_count=0}}}}return true}}registerProcessor("zoomAudioWorklet",ZoomAudioWorletProcessor);